<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Field Data Logger - Mobile First</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --color-white: #ffffff;
      --color-black: #000000;
      --color-cream-50: #fcfcf9;
      --color-cream-100: #fffffd;
      --color-gray-200: #f5f5f5;
      --color-gray-300: #a7a9a9;
      --color-gray-400: #777c7c;
      --color-slate-500: #626c71;
      --color-brown-600: #5e5240;
      --color-charcoal-700: #1f2121;
      --color-charcoal-800: #262828;
      --color-slate-900: #13343b;
      --color-teal-300: #32b8c6;
      --color-teal-400: #2da6b2;
      --color-teal-500: #218089;
      --color-teal-600: #1d7480;
      --color-teal-700: #1a6873;
      --color-teal-800: #2996a1;
      --color-red-400: #ff5459;
      --color-red-500: #c0152f;
      --color-orange-400: #e68161;
      --color-orange-500: #a84b2f;
      --color-gray-500: #9ca3af;

      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-border: rgba(94, 82, 64, 0.2);
      --color-card-border: rgba(94, 82, 64, 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);

      --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-md: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;

      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;

      --space-2: 2px;
      --space-4: 4px;
      --space-6: 6px;
      --space-8: 8px;
      --space-10: 10px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);

      --focus-ring: 0 0 0 3px rgba(33, 128, 141, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family-base);
      background-color: var(--color-background);
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin: 0;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      letter-spacing: -0.01em;
    }

    h1 {
      font-size: var(--font-size-2xl);
    }

    h2 {
      font-size: var(--font-size-xl);
    }

    p {
      margin: 0;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-card-border);
      padding: var(--space-12) var(--space-12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-8);
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .app-title h1 {
      font-size: var(--font-size-xl);
    }

    .app-subtitle {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .app-body {
      flex: 1;
      padding: var(--space-12) var(--space-12) var(--space-16);
      display: flex;
      flex-direction: column;
      gap: var(--space-12);
      max-width: 100%;
      overflow-y: auto;
    }

    .card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      box-shadow: var(--shadow-sm);
      padding: var(--space-12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-8);
    }

    .card-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--color-text-secondary);
    }

    .card-subtitle {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-4);
    }

    /* GitHub Sync Button */

    .github-sync-button {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-8);
      padding: var(--space-10) var(--space-12);
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: all 150ms ease;
      width: 100%;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }

    .github-sync-button:hover {
      border-color: var(--color-primary);
      background: rgba(33, 128, 141, 0.04);
    }

    .github-button-left {
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--color-gray-500);
      transition: background-color 200ms ease;
      flex-shrink: 0;
    }

    .status-indicator.connected {
      background: var(--color-success);
    }

    .github-button-text {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      text-align: left;
    }

    .github-button-label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
    }

    .github-button-status {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .chevron {
      transition: transform 150ms ease;
      font-size: 14px;
      color: var(--color-text-secondary);
      flex-shrink: 0;
    }

    .chevron.open {
      transform: rotate(90deg);
    }

    /* GitHub Panel (Collapsible) */

    .github-panel {
      display: none;
      flex-direction: column;
      gap: var(--space-12);
      margin-top: var(--space-12);
      padding-top: var(--space-12);
      border-top: 1px solid var(--color-card-border);
    }

    .github-panel.open {
      display: flex;
    }

    /* Form */

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .form-row {
      display: flex;
      gap: var(--space-8);
    }

    .form-row > .form-group {
      flex: 1;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .form-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .form-control,
    select {
      width: 100%;
      padding: var(--space-8) var(--space-10);
      font-size: var(--font-size-md);
      border-radius: var(--radius-base);
      border: 1px solid var(--color-border);
      background-color: var(--color-surface);
      color: var(--color-text);
      outline: none;
      transition: border-color 150ms ease, box-shadow 150ms ease, background-color 150ms ease;
    }

    .form-control:focus,
    select:focus {
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
      background-color: #ffffff;
    }

    .radio-group,
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-6);
      padding: var(--space-6) var(--space-10);
      border-radius: var(--radius-full);
      border: 1px solid rgba(94, 82, 64, 0.2);
      background: rgba(255, 255, 255, 0.9);
      font-size: var(--font-size-sm);
      cursor: pointer;
      user-select: none;
    }

    .chip input {
      width: 16px;
      height: 16px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .helper-text {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    /* Buttons */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-6);
      padding: var(--space-8) var(--space-16);
      border-radius: var(--radius-base);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      transition: background-color 150ms ease, box-shadow 150ms ease, transform 120ms ease;
      text-decoration: none;
      white-space: nowrap;
      min-height: 44px;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-cream-50);
    }

    .btn-primary:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-0.5px);
      box-shadow: var(--shadow-md);
    }

    .btn-ghost {
      background: transparent;
      color: var(--color-text);
      border: 1px solid rgba(94, 82, 64, 0.2);
    }

    .btn-ghost:hover {
      background: rgba(94, 82, 64, 0.06);
    }

    .btn-outline {
      background: transparent;
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-outline:hover {
      background: rgba(94, 82, 64, 0.06);
    }

    .btn-danger {
      background: var(--color-error);
      color: white;
    }

    .btn-danger:hover {
      filter: brightness(0.95);
    }

    .btn-sm {
      padding: var(--space-4) var(--space-10);
      font-size: var(--font-size-sm);
      min-height: 32px;
    }

    .btn-full {
      width: 100%;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* Entry Cards */

    .entries-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .entry-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(33, 128, 141, 0.2);
      padding: var(--space-10);
      background: linear-gradient(
        135deg,
        rgba(33, 128, 141, 0.06),
        rgba(255, 255, 255, 0.95)
      );
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      cursor: pointer;
      transition: all 150ms ease;
    }

    .entry-card:hover {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .entry-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-8);
    }

    .entry-activity-time {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .entry-activity {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
    }

    .entry-time {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .entry-pill {
      padding: var(--space-2) var(--space-8);
      border-radius: 999px;
      border: 1px solid rgba(33, 128, 141, 0.3);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }

    .entry-details {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .entry-meta {
      display: flex;
      justify-content: space-between;
      gap: var(--space-8);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .entry-duration {
      font-weight: var(--font-weight-medium);
      color: var(--color-primary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-12);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    /* Data log modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: var(--space-12);
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(94, 82, 64, 0.18);
      box-shadow: var(--shadow-lg);
      max-width: 960px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: var(--space-12) var(--space-16);
      border-bottom: 1px solid rgba(94, 82, 64, 0.12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-8);
    }

    .modal-title-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .modal-title {
      font-size: var(--font-size-lg);
    }

    .modal-subtitle {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .modal-body {
      padding: var(--space-12) var(--space-16);
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-xs);
    }

    thead {
      position: sticky;
      top: 0;
      background: var(--color-cream-100);
      z-index: 1;
    }

    th,
    td {
      padding: var(--space-8);
      border-bottom: 1px solid rgba(94, 82, 64, 0.12);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:nth-child(even) {
      background: rgba(94, 82, 64, 0.03);
    }

    tbody tr:hover {
      background: rgba(33, 128, 141, 0.06);
    }

    .table-actions {
      display: flex;
      gap: var(--space-4);
    }

    .toast {
      position: fixed;
      bottom: var(--space-12);
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-charcoal-800);
      color: var(--color-cream-50);
      padding: var(--space-8) var(--space-16);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-lg);
      font-size: var(--font-size-sm);
      display: none;
      align-items: center;
      gap: var(--space-8);
      z-index: 60;
    }

    .toast.show {
      display: inline-flex;
      animation: fadeInUp 200ms ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translate(-50%, 8px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
    }

    .quick-actions .btn {
      flex: 1;
      min-width: 48%;
    }

    .edit-form-grid {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    /* Desktop layout - side by side */
    @media (min-width: 1200px) {
      .app-body {
        flex-direction: row;
        gap: var(--space-16);
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: var(--space-12) var(--space-16) var(--space-16);
      }

      .main-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--space-12);
        min-width: 0;
      }

      .side-column {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: var(--space-12);
        max-height: calc(100vh - 180px);
        overflow-y: auto;
      }

      .card {
        padding: var(--space-12);
      }

      .form-grid {
        gap: var(--space-6);
      }

      .form-group {
        gap: var(--space-2);
      }

      .form-control,
      select {
        padding: var(--space-6) var(--space-8);
        font-size: var(--font-size-sm);
      }

      .form-label {
        font-size: var(--font-size-xs);
      }

      .btn {
        padding: var(--space-6) var(--space-12);
        font-size: var(--font-size-sm);
        min-height: 36px;
      }

      .card-title {
        font-size: var(--font-size-xs);
      }

      .card-subtitle {
        font-size: var(--font-size-xs);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">
        <h1>Field Data Logger</h1>
        <div class="app-subtitle">Portrait · Mobile first</div>
      </div>
      <button class="btn btn-ghost btn-sm" id="viewLogBtn">View Log</button>
    </header>

    <main class="app-body">
      <div class="main-column">
        <!-- GitHub Sync Collapsible Button -->
        <button class="github-sync-button" id="githubSyncToggle">
          <div class="github-button-left">
            <div class="status-indicator" id="statusIndicator"></div>
            <div class="github-button-text">
              <div class="github-button-label">GitHub Sync</div>
              <div class="github-button-status" id="githubStatusText">Not connected</div>
            </div>
          </div>
          <span class="chevron" id="githubChevron">›</span>
        </button>

        <!-- GitHub Panel (Collapsible) -->
        <div class="github-panel" id="githubPanel">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="githubUsername">GitHub Username</label>
              <input
                id="githubUsername"
                class="form-control"
                type="text"
                value="thatsrikki"
                placeholder="your-username"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="githubRepo">Repository Name</label>
              <input
                id="githubRepo"
                class="form-control"
                type="text"
                value="field_data_logger"
                placeholder="field-data-logger"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="githubToken">Personal Access Token</label>
              <input
                id="githubToken"
                class="form-control"
                type="password"
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
              />
              <div class="helper-text">
                Fine-grained token • repository access: this repo only • permissions: contents (read/write)
              </div>
            </div>
            <button class="btn btn-primary btn-full" id="connectGitHubBtn">
              Connect to GitHub
            </button>
          </div>
        </div>

        <!-- Entry Form Card -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Entry Form</div>
              <div class="card-subtitle">Enter data, then submit.</div>
            </div>
            <button class="btn btn-outline btn-sm" id="startDayBtn">Start Day</button>
          </div>

          <div class="form-grid">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="projectName">Project</label>
                <input
                  id="projectName"
                  class="form-control"
                  type="text"
                  value="OC25-16"
                  placeholder="e.g., OC25-16"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="cityName">City</label>
                <input
                  id="cityName"
                  class="form-control"
                  type="text"
                  placeholder="e.g., Ocala"
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="entryType">Entry Type</label>
              <select id="entryType" class="form-control">
                <option value="pole">Pole</option>
                <option value="activity">Activity</option>
              </select>
            </div>

            <!-- Pole section -->
            <div id="poleSection">
              <div class="form-group">
                <label class="form-label">Pole Type</label>
                <div class="radio-group">
                  <label class="chip">
                    <input
                      type="radio"
                      name="poleType"
                      value="primary"
                      id="primaryPole"
                      checked
                    />
                    Primary (P1, P2)
                  </label>
                  <label class="chip">
                    <input
                      type="radio"
                      name="poleType"
                      value="adjacent"
                      id="adjacentPole"
                    />
                    Adjacent (P1.1, P1.2)
                  </label>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="poleId">Pole ID</label>
                  <input
                    id="poleId"
                    class="form-control"
                    type="text"
                    placeholder="e.g., P1 or P1.1"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label" for="poleTime">Time</label>
                  <input
                    id="poleTime"
                    class="form-control"
                    type="text"
                    placeholder="e.g., 9:04:00 AM"
                  />
                </div>
              </div>

              <div id="primaryFields">
                <div class="form-group">
                  <label class="form-label">Attachments</label>
                  <div class="checkbox-group">
                    <label class="chip">
                      <input type="checkbox" id="attachTx" value="Tx" />
                      Tx
                    </label>
                    <label class="chip">
                      <input type="checkbox" id="attachDg" value="DG" />
                      DG
                    </label>
                    <label class="chip">
                      <input type="checkbox" id="attachRiser" value="Riser" />
                      Riser
                    </label>
                  </div>
                  <div class="helper-text">
                    DG anchors field appears when DG is selected.
                  </div>
                </div>

                <div class="form-group" id="dgAnchorField" style="display:none;">
                  <label class="form-label" for="dgAnchors">DG Anchors</label>
                  <select id="dgAnchors" class="form-control">
                    <option value="">None</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>
              </div>

              <div id="adjacentFields" style="display:none;">
                <div class="form-group">
                  <label class="form-label" for="spanDirection">Direction + Span</label>
                  <select id="spanDirection" class="form-control">
                    <option value="">Select span...</option>
                    <option value="s span">s span</option>
                    <option value="nw span">nw span</option>
                    <option value="ne span">ne span</option>
                    <option value="e span">e span</option>
                    <option value="sw span 1">sw span 1</option>
                    <option value="sw span 2">sw span 2</option>
                    <option value="w span">w span</option>
                    <option value="se span">se span</option>
                  </select>
                </div>
              </div>

              <button class="btn btn-primary btn-full" id="addPoleBtn">
                Add Pole Entry
              </button>
            </div>

            <!-- Activity section -->
            <div id="activitySection" style="display:none;">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="activityType">Activity</label>
                  <select id="activityType" class="form-control">
                    <option value="Break">Break</option>
                    <option value="Lunch">Lunch</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="activityTime">Time</label>
                  <input
                    id="activityTime"
                    class="form-control"
                    type="text"
                    placeholder="e.g., 10:00:00 AM"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="activityDescription">Description</label>
                <input
                  id="activityDescription"
                  class="form-control"
                  type="text"
                  placeholder="e.g., bathroom, lunch break"
                />
              </div>

              <button class="btn btn-primary btn-full" id="addActivityBtn">
                Add Activity Entry
              </button>
            </div>
          </div>
        </div>

        <!-- Recent Entries (Last 3) -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Recent Entries</div>
              <div class="card-subtitle">Last 3 entries. Click to edit.</div>
            </div>
          </div>
          <div id="recentEntriesContainer">
            <div class="empty-state">No entries yet. Add your first entry above.</div>
          </div>
        </div>
      </div>

      <div class="side-column">
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Export & Manage</div>
            </div>
          </div>
          <div class="quick-actions">
            <button class="btn btn-outline btn-sm" id="exportCsvBtn">Export CSV</button>
            <button class="btn btn-outline btn-sm" id="copyTextBtn">Copy Text</button>
            <button class="btn btn-outline btn-sm" id="exportStartNewBtn">Export & New</button>
            <button class="btn btn-danger btn-sm" id="clearAllBtn">Clear All</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Data log modal -->
  <div class="modal-backdrop" id="logModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title-group">
          <div class="modal-title">Field Data Log</div>
          <div class="modal-subtitle">
            Full view of all entries. Tap Edit/Delete as needed.
          </div>
        </div>
        <button class="btn btn-icon btn-outline" id="closeLogModalBtn">✕</button>
      </div>
      <div class="modal-body">
        <div
          style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"
        >
          <small style="font-size:11px;color:var(--color-text-secondary);">
            Total entries: <span id="entryCountModal">0</span>
          </small>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Activity</th>
                <th>Work Details</th>
                <th>Time Stamps</th>
                <th>Duration</th>
                <th>Pole Attachments</th>
                <th>DG Anchors</th>
                <th>Project</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div class="modal-backdrop" id="editModalBackdrop">
    <div class="modal" style="max-width:640px;">
      <div class="modal-header">
        <div class="modal-title-group">
          <div class="modal-title">Edit Entry</div>
          <div class="modal-subtitle">Adjust fields, then save changes.</div>
        </div>
        <button class="btn btn-icon btn-outline" id="closeEditModalBtn">✕</button>
      </div>
      <div class="modal-body">
        <div class="edit-form-grid" id="editForm"></div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn btn-primary btn-sm" id="saveEditBtn" style="flex:1;">Save</button>
          <button class="btn btn-outline btn-sm" id="cancelEditBtn" style="flex:1;">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const dataLog = [];
    let editingIndex = -1;
    let githubConfig = null;

    const field = (id) => document.getElementById(id);

    function showToast(message) {
      const toast = field("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2200);
    }

    // Parse time string (e.g., "9:04:00 AM") to minutes since midnight
    function timeToMinutes(timeStr) {
      if (!timeStr) return null;
      const match = timeStr.match(/(\d+):(\d+):(\d+)\s*(AM|PM)?/i);
      if (!match) return null;
      
      let hours = parseInt(match[1], 10);
      const minutes = parseInt(match[2], 10);
      const seconds = parseInt(match[3], 10);
      const period = match[4] ? match[4].toUpperCase() : '';

      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      return hours * 60 + minutes + seconds / 60;
    }

    // Convert minutes to HH:MM:SS format
    function minutesToDuration(minutes) {
      if (!minutes || minutes < 0) return '';
      
      const hours = Math.floor(minutes / 60);
      const mins = Math.floor(minutes % 60);
      const secs = Math.round((minutes % 1) * 60);

      return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Calculate durations for all entries
    function calculateDurations() {
      for (let i = 0; i < dataLog.length; i++) {
        if (i < dataLog.length - 1) {
          const currentTime = timeToMinutes(dataLog[i].timeStamps);
          const nextTime = timeToMinutes(dataLog[i + 1].timeStamps);
          
          if (currentTime !== null && nextTime !== null) {
            let duration = nextTime - currentTime;
            // Handle case where next day (e.g., 11:00 PM to 1:00 AM next day)
            if (duration < 0) {
              duration += 24 * 60;
            }
            dataLog[i].duration = minutesToDuration(duration);
          }
        } else {
          // Last entry has no duration (no next entry yet)
          dataLog[i].duration = '';
        }
      }
    }

    function updateGitHubStatus(connected) {
      const indicator = field("statusIndicator");
      const statusText = field("githubStatusText");
      if (connected && githubConfig) {
        indicator.classList.add("connected");
        statusText.textContent = "Connected to GitHub";
      } else {
        indicator.classList.remove("connected");
        statusText.textContent = "Not connected";
      }
    }

    function renderRecentEntries() {
      const container = field("recentEntriesContainer");
      if (dataLog.length === 0) {
        container.innerHTML =
          '<div class="empty-state">No entries yet. Add your first entry above.</div>';
        return;
      }

      // Get last 3 entries
      const lastThree = dataLog.slice(-3).reverse();
      
      container.innerHTML = '';
      const entriesDiv = document.createElement('div');
      entriesDiv.className = 'entries-container';

      lastThree.forEach((entry, displayIndex) => {
        const actualIndex = dataLog.length - 3 + displayIndex;
        const div = document.createElement("div");
        div.className = "entry-card";
        div.style.cursor = "pointer";

        const activity = entry.activity || "";
        const time = entry.timeStamps || "";
        const work = entry.workDetails || "";
        const proj = entry.project || "";
        const attachments = entry.poleAttachments || "";
        const dg = entry.dgAnchors || "";
        const duration = entry.duration || "";

        div.innerHTML = `
          <div class="entry-row">
            <div class="entry-activity-time">
              <div class="entry-activity">${escapeHtml(activity)}</div>
              <div class="entry-time">${escapeHtml(time)}</div>
            </div>
            <div class="entry-pill">${escapeHtml(proj || "OC25-16")}</div>
          </div>
          <div class="entry-details">
            ${escapeHtml(work || "")}
          </div>
          ${
            attachments || dg
              ? `<div class="entry-meta">
              <div>${escapeHtml(attachments)}</div>
              <div>${dg ? "DG: " + escapeHtml(dg) : ""}</div>
            </div>`
              : ""
          }
          ${
            duration
              ? `<div style="font-size:var(--font-size-xs);color:var(--color-text-secondary);border-top:1px solid rgba(94,82,64,0.12);padding-top:var(--space-6);margin-top:var(--space-6);">Duration: <span class="entry-duration">${escapeHtml(duration)}</span></div>`
              : ""
          }
        `;

        div.addEventListener('click', () => openEditModal(actualIndex));
        entriesDiv.appendChild(div);
      });

      container.appendChild(entriesDiv);
    }

    function renderLogTable() {
      const body = field("logTableBody");
      body.innerHTML = "";
      field("entryCountModal").textContent = dataLog.length;

      dataLog.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(row.activity)}</td>
          <td>${escapeHtml(row.workDetails)}</td>
          <td>${escapeHtml(row.timeStamps)}</td>
          <td>${escapeHtml(row.duration || "")}</td>
          <td>${escapeHtml(row.poleAttachments || "")}</td>
          <td>${escapeHtml(row.dgAnchors || "")}</td>
          <td>${escapeHtml(row.project || "")}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-outline btn-sm" data-edit="${index}">Edit</button>
              <button class="btn btn-danger btn-sm" data-delete="${index}">Delete</button>
            </div>
          </td>
        `;
        body.appendChild(tr);
      });

      body.querySelectorAll("[data-edit]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const index = parseInt(e.target.dataset.edit, 10);
          openEditModal(index);
        });
      });

      body.querySelectorAll("[data-delete]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const index = parseInt(e.target.dataset.delete, 10);
          deleteEntry(index);
        });
      });
    }

    function escapeHtml(text) {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;",
      };
      return String(text || "").replace(/[&<>"']/g, (m) => map[m]);
    }

    function addPoleEntry() {
      const projectName = field("projectName").value || "OC25-16";
      const poleId = field("poleId").value.trim();
      const timeStamps = field("poleTime").value.trim();
      const primary = field("primaryPole").checked;
      let workDetails = "";
      let poleAttachments = "";
      let dgAnchors = "";

      if (!poleId || !timeStamps) {
        alert("Pole ID and Time are required.");
        return;
      }

      if (primary) {
        workDetails = "pole";
        const attachments = [];
        if (field("attachTx").checked) attachments.push("Tx");
        if (field("attachDg").checked) attachments.push("DG");
        if (field("attachRiser").checked) attachments.push("Riser");
        poleAttachments = attachments.join(", ");
        dgAnchors = field("dgAnchors").value;
      } else {
        const spanDir = field("spanDirection").value;
        workDetails = spanDir;
      }

      dataLog.push({
        activity: poleId,
        workDetails,
        timeStamps,
        duration: "",
        poleAttachments,
        dgAnchors,
        project: projectName,
      });

      field("poleId").value = "";
      field("poleTime").value = "";
      field("attachTx").checked = false;
      field("attachDg").checked = false;
      field("attachRiser").checked = false;
      field("dgAnchors").value = "";
      field("spanDirection").value = "";
      updateDgAnchorVisibility();

      calculateDurations();
      renderRecentEntries();
      renderLogTable();
      autoSaveToGitHub();
      showToast("✓ Pole entry added");
    }

    function addActivity() {
      const projectName = field("projectName").value || "OC25-16";
      const activityType = field("activityType").value;
      const description = field("activityDescription").value.trim();
      const timeStamps = field("activityTime").value.trim();

      if (!description || !timeStamps) {
        alert("Description and Time are required.");
        return;
      }

      dataLog.push({
        activity: activityType,
        workDetails: description,
        timeStamps,
        duration: "",
        poleAttachments: "",
        dgAnchors: "",
        project: projectName,
      });

      field("activityDescription").value = "";
      field("activityTime").value = "";

      calculateDurations();
      renderRecentEntries();
      renderLogTable();
      autoSaveToGitHub();
      showToast("✓ Activity entry added");
    }

    function startDay() {
      const projectName = field("projectName").value || "OC25-16";
      const cityName = field("cityName").value.trim();

      if (!cityName) {
        alert("Enter a city before starting the day.");
        return;
      }

      const now = new Date();
      
      // Create Traveling entry
      const travelTime = now.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      dataLog.push({
        activity: "Traveling",
        workDetails: `Driving to ${cityName}`,
        timeStamps: travelTime,
        duration: "",
        poleAttachments: "",
        dgAnchors: "",
        project: projectName,
      });

      // Create Arrived entry (2 hours later)
      const arrivedDate = new Date(now.getTime() + 2 * 60 * 60 * 1000);
      const arrivedTime = arrivedDate.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      dataLog.push({
        activity: "Arrived",
        workDetails: "Parked at Jobsite",
        timeStamps: arrivedTime,
        duration: "",
        poleAttachments: "",
        dgAnchors: "",
        project: projectName,
      });

      // Create Setup entry (15 minutes after Arrived)
      const setupDate = new Date(arrivedDate.getTime() + 15 * 60 * 1000);
      const setupTime = setupDate.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      dataLog.push({
        activity: "Setup",
        workDetails: "Equip. and plan route",
        timeStamps: setupTime,
        duration: "",
        poleAttachments: "",
        dgAnchors: "",
        project: projectName,
      });

      // Now calculate all durations
      calculateDurations();
      renderRecentEntries();
      renderLogTable();
      autoSaveToGitHub();
      showToast("Day started · 3 entries added");
    }

    function openLogModal() {
      field("logModalBackdrop").classList.add("open");
      renderLogTable();
    }

    function closeLogModal() {
      field("logModalBackdrop").classList.remove("open");
    }

    function openEditModal(index) {
      editingIndex = index;
      const row = dataLog[index];
      const container = field("editForm");
      container.innerHTML = "";

      const fields = [
        ["Activity", "activity"],
        ["Work Details", "workDetails"],
        ["Time Stamps", "timeStamps"],
        ["Duration", "duration"],
        ["Pole Attachments", "poleAttachments"],
        ["DG Anchors", "dgAnchors"],
        ["Project", "project"],
      ];

      fields.forEach(([label, key]) => {
        const group = document.createElement("div");
        group.className = "form-group";
        group.innerHTML = `
          <label class="form-label">${label}</label>
          <input class="form-control" type="text" id="edit_${key}" value="${escapeHtml(
          row[key] || ""
        )}" />
        `;
        container.appendChild(group);
      });

      field("editModalBackdrop").classList.add("open");
    }

    function closeEditModal() {
      editingIndex = -1;
      field("editModalBackdrop").classList.remove("open");
    }

    function saveEdit() {
      if (editingIndex < 0) return;
      const row = dataLog[editingIndex];

      row.activity = field("edit_activity").value;
      row.workDetails = field("edit_workDetails").value;
      row.timeStamps = field("edit_timeStamps").value;
      row.duration = field("edit_duration").value;
      row.poleAttachments = field("edit_poleAttachments").value;
      row.dgAnchors = field("edit_dgAnchors").value;
      row.project = field("edit_project").value;

      closeEditModal();
      calculateDurations();
      renderRecentEntries();
      renderLogTable();
      autoSaveToGitHub();
      showToast("✓ Entry updated");
    }

    function deleteEntry(index) {
      if (!confirm("Delete this entry?")) return;
      dataLog.splice(index, 1);
      calculateDurations();
      renderRecentEntries();
      renderLogTable();
      autoSaveToGitHub();
      showToast("Entry deleted");
    }

    function clearAll() {
      if (!confirm("Clear all entries? This cannot be undone.")) return;
      dataLog.length = 0;
      renderRecentEntries();
      renderLogTable();
      showToast("All entries cleared");
    }

    function generateCSV() {
      const headers = [
        "Activity",
        "Work Details",
        "Time Stamps",
        "Duration",
        "Pole Attachments",
        "DG Anchors",
        "Project",
      ];
      const rows = dataLog.map((row) => [
        row.activity || "",
        row.workDetails || "",
        row.timeStamps || "",
        row.duration || "",
        row.poleAttachments || "",
        row.dgAnchors || "",
        row.project || "",
      ]);

      let csv = headers.map((h) => '"' + h + '"').join(",") + "\n";
      rows.forEach((row) => {
        csv +=
          row
            .map((cell) =>
              '"' + String(cell).replace(/"/g, '""') + '"'
            )
            .join(",") + "\n";
      });
      return csv;
    }

    function exportCSV() {
      if (!dataLog.length) {
        alert("No data to export.");
        return;
      }
      const csv = generateCSV();
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download =
        "field-data-" + new Date().toISOString().split("T")[0] + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("CSV exported");
    }

    function copyText() {
      if (!dataLog.length) {
        alert("No data to copy.");
        return;
      }
      const headers = [
        "Activity",
        "Work Details",
        "Time Stamps",
        "Duration",
        "Pole Attachments",
        "DG Anchors",
        "Project",
      ];
      let text = headers.join("\t") + "\n";
      dataLog.forEach((row) => {
        text +=
          [
            row.activity || "",
            row.workDetails || "",
            row.timeStamps || "",
            row.duration || "",
            row.poleAttachments || "",
            row.dgAnchors || "",
            row.project || "",
          ].join("\t") + "\n";
      });
      navigator.clipboard.writeText(text).then(() => {
        showToast("Copied to clipboard");
      });
    }

    function exportAndStartNew() {
      if (!dataLog.length) {
        alert("No data to export.");
        return;
      }
      exportCSV();
      setTimeout(() => {
        if (!confirm("Start a new session and clear current entries?")) return;
        dataLog.length = 0;
        renderRecentEntries();
        renderLogTable();
        showToast("New session started");
      }, 400);
    }

    function updateEntryTypeVisibility() {
      const type = field("entryType").value;
      if (type === "pole") {
        field("poleSection").style.display = "";
        field("activitySection").style.display = "none";
      } else {
        field("poleSection").style.display = "none";
        field("activitySection").style.display = "";
      }
    }

    function updatePoleTypeVisibility() {
      const primary = field("primaryPole").checked;
      field("primaryFields").style.display = primary ? "" : "none";
      field("adjacentFields").style.display = primary ? "none" : "";
    }

    function updateDgAnchorVisibility() {
      const show = field("attachDg").checked;
      field("dgAnchorField").style.display = show ? "" : "none";
    }

    function toggleGitHubPanel() {
      const panel = field("githubPanel");
      const chevron = field("githubChevron");
      const isOpen = panel.classList.contains("open");
      if (isOpen) {
        panel.classList.remove("open");
        chevron.classList.remove("open");
      } else {
        panel.classList.add("open");
        chevron.classList.add("open");
      }
    }

    function connectGitHub() {
      const username = field("githubUsername").value.trim();
      const repo = field("githubRepo").value.trim();
      const token = field("githubToken").value.trim();
      if (!username || !repo || !token) {
        alert("Fill username, repo, and token.");
        return;
      }
      githubConfig = { username, repo, token };
      updateGitHubStatus(true);
      showToast("✓ Connected to GitHub");
    }

    async function autoSaveToGitHub() {
      if (!githubConfig) return;
      try {
        const csv = generateCSV();
        const content = btoa(csv);
        const filename =
          "field-data-" + new Date().toISOString().split("T")[0] + ".csv";
        const auth = "Basic " + btoa(githubConfig.username + ":" + githubConfig.token);

        const res = await fetch(
          "https://api.github.com/repos/" +
            githubConfig.username +
            "/" +
            githubConfig.repo +
            "/contents/" +
            filename,
          {
            method: "PUT",
            headers: {
              Authorization: auth,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: "Update field data - " + new Date().toLocaleString(),
              content,
            }),
          }
        );
        if (res.ok) {
          // Silent save
        } else {
          console.warn("GitHub save failed");
        }
      } catch (err) {
        console.warn("GitHub error", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateEntryTypeVisibility();
      updatePoleTypeVisibility();
      updateDgAnchorVisibility();
      renderRecentEntries();
      renderLogTable();

      field("entryType").addEventListener("change", updateEntryTypeVisibility);
      field("primaryPole").addEventListener("change", updatePoleTypeVisibility);
      field("adjacentPole").addEventListener("change", updatePoleTypeVisibility);
      field("attachDg").addEventListener("change", updateDgAnchorVisibility);
      field("githubSyncToggle").addEventListener("click", toggleGitHubPanel);
      field("connectGitHubBtn").addEventListener("click", connectGitHub);

      field("addPoleBtn").addEventListener("click", addPoleEntry);
      field("addActivityBtn").addEventListener("click", addActivity);
      field("startDayBtn").addEventListener("click", startDay);

      field("viewLogBtn").addEventListener("click", openLogModal);
      field("closeLogModalBtn").addEventListener("click", closeLogModal);

      field("closeEditModalBtn").addEventListener("click", closeEditModal);
      field("cancelEditBtn").addEventListener("click", closeEditModal);
      field("saveEditBtn").addEventListener("click", saveEdit);

      field("exportCsvBtn").addEventListener("click", exportCSV);
      field("copyTextBtn").addEventListener("click", copyText);
      field("exportStartNewBtn").addEventListener("click", exportAndStartNew);
      field("clearAllBtn").addEventListener("click", clearAll);
    });
  </script>
</body>
</html>
